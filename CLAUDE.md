# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Next.js AI Chatbot built with AI SDK, featuring multimodal chat, artifacts (code/image/sheet/text editing), and real-time collaboration capabilities. Uses xAI models (Grok) via Vercel AI Gateway.

## Development Commands

```bash
pnpm dev                 # Start dev server on port 4000 with Turbo
pnpm build              # Run migrations then build for production
pnpm lint               # Check code with Ultracite (Biome-based)
pnpm format             # Auto-fix code with Ultracite

# Database (Drizzle ORM + PostgreSQL)
pnpm db:migrate         # Apply migrations
pnpm db:generate        # Generate new migrations from schema
pnpm db:studio          # Open Drizzle Studio GUI
pnpm db:push            # Push schema changes directly (dev only)

# Testing
pnpm test               # Run Playwright e2e tests
```

## Architecture

### AI Provider System (`lib/ai/providers.ts`)
- **Production**: Uses Vercel AI Gateway to route to xAI models (Grok)
  - `chat-model`: grok-2-vision-1212 (multimodal)
  - `chat-model-reasoning`: grok-3-mini (with reasoning extraction middleware)
  - `title-model`/`artifact-model`: grok-2-1212
- **Test Environment**: Auto-switches to mock models from `models.mock.ts`
- Environment detection via `lib/constants.ts` (`isTestEnvironment`, `isProductionEnvironment`)

### Authentication Flow (`middleware.ts` + `app/(auth)/`)
- Uses NextAuth.js 5.0 beta with JWT tokens
- Guest mode: Auto-redirects unauthenticated users to `/api/auth/guest` 
- Guest regex pattern: `guest-\d+` (defined in `lib/constants.ts`)
- Middleware protects all routes except auth endpoints and static assets

### Data Layer (`lib/db/`)
- **ORM**: Drizzle with PostgreSQL (Neon Serverless)
- **Schema** (`schema.ts`): User, Chat, Message_v2 (new), Message (deprecated)
- **Queries** (`queries.ts`): Pre-built query functions
- Message versioning: `Message_v2` with parts/attachments, old `Message` table deprecated
- See migration guide at https://chat-sdk.dev/docs/migration-guides/message-parts

### Artifacts System (`artifacts/`)
Editable artifacts generated by AI:
- **Types**: code, image, sheet (spreadsheet), text (Markdown editor)
- **Server Actions**: `artifacts/actions.ts` - getSuggestions
- **Type-specific actions**: Each artifact type (code/image/sheet/text) has its own subdirectory with actions

### Chat System (`app/(chat)/` + `components/chat.tsx`)
- Uses AI SDK's `useChat` hook with custom transport
- Server Actions in `app/(chat)/actions.ts`:
  - `generateTitleFromUserMessage`: Auto-generate chat titles
  - `deleteTrailingMessages`: Delete messages after a timestamp
  - `updateChatVisibility`: Toggle public/private
- Real-time updates via SWR

### Tools (`lib/ai/tools/`)
- `create-document.ts` / `update-document.ts`: Artifact creation/editing
- `get-weather.ts`: Example tool
- `request-suggestions.ts`: Generate suggestions for artifacts

## Code Standards (Ultracite Rules)

This project enforces strict lint/format rules via Ultracite (wraps Biome). Key requirements:

**TypeScript**:
- NO `any` type, enums, namespaces, non-null assertions (`!`)
- Use `import type` and `export type` for types
- Use `T[]` or `Array<T>` consistently
- NO parameter properties in constructors

**React**:
- Hooks must follow rules of hooks (top-level, dependency arrays)
- NO Array index as keys
- Use `<>...</>` instead of `<Fragment>`
- NO destructuring props in Solid components

**Next.js Specific**:
- NO `<img>` (use next/image)
- NO `<head>` (use next/head or metadata)
- NO importing `next/document` outside `pages/_document`

**General**:
- Use `const` by default, NO `var`
- Arrow functions over function expressions
- Use `===` instead of `==`
- NO console statements (disabled in production)
- Use `for-of` instead of `.forEach()`

See `.cursor/rules/ultracite.mdc` for full lint rules.

## Testing Strategy

- **E2E**: Playwright (config in `playwright.config.ts`)
- **Environment**: Set `PLAYWRIGHT=True` env var for tests
- **Mock Models**: AI models auto-switch to mocks when `isTestEnvironment` is true
- **Ping Endpoint**: `/ping` returns 200 for test runner health checks

## Path Aliases

All imports use `@/*` alias mapping to project root (configured in `tsconfig.json`).

## Environment Variables

Required vars (see `.env.example`):
- `POSTGRES_URL`: Database connection
- `AUTH_SECRET`: NextAuth secret
- `AI_GATEWAY_API_KEY`: Only needed for non-Vercel deployments (OIDC used on Vercel)
- Optional: Direct provider keys if not using AI Gateway

## File Storage

Uses Vercel Blob for efficient file uploads (e.g., image attachments).